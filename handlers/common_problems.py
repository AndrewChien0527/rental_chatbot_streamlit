import streamlit as st
from utils.rag import rag_lookup
from utils.flow_manage import gen_prompt, generate_response


def add_chat(role, content):
    with st.chat_message(role):
        st.markdown(content)
    st.session_state.messages.append({"role": role, "content": content})




def build_history():
    messages = st.session_state.get("messages", [])
    history_text = ""
    for msg in messages:
        role = "ä½¿ç”¨è€…" if msg["role"] == "user" else "åŠ©ç†"
        history_text += f"{role}ï¼š{msg['content']}\n"
    return "" #history_text
   


def handle_common_problem(intro_msg = "è«‹æè¿°ä½ é‡åˆ°çš„å•é¡Œï¼Œæˆ‘æœƒæä¾›å¯èƒ½è™•ç†æ–¹å¼ï¼Œä¾‹å¦‚ç”³è¨´å–®ä½ã€æ³•å¾‹ä¾æ“šæˆ–æºé€šæŠ€å·§ã€‚",history=""):
    # Initialize session state once
    if "messages" not in st.session_state:
        st.session_state.messages = []

    if "intro_shown" not in st.session_state:
        st.session_state.intro_shown = False

    # Render Clear Chat button at the top (not sidebar)
    for msg in st.session_state.messages:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

    
    # Show the intro message only once
    if not st.session_state.intro_shown:
        intro_msg = intro_msg
        add_chat("assistant", intro_msg)
        st.session_state.intro_shown = True

    # Wait for user input
    user_text = st.chat_input("è«‹è¼¸å…¥å•é¡Œ")
    if user_text and user_text.strip():
        add_chat("user", user_text.strip())

        try:
            with st.spinner("æ€è€ƒä¸­..."):
                # Do RAG retrieval
                context = rag_lookup(user_text, top_k=1, threshold=0.1)
                if not context:
                    context = ""

                # Generate prompt + response
                prompt = gen_prompt(user_text,history, context=context)

                answer = generate_response(prompt)

            # Display answer
            add_chat("assistant",context)# answer+"/n"+ prompt)

        except Exception as e:
            add_chat("assistant", f"âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")
    if st.button("ğŸ”„ æ¸…é™¤å°è©±"):
        st.session_state.messages.clear()
        
first_rent_intro_message='''æ‰¾æˆ¿å»ºè­°æ³¨æ„ï¼šäº¤é€šã€ç§Ÿé‡‘è¡Œæƒ…ã€æˆ¿æ±èº«åˆ†ã€åˆç´„æ¢æ¬¾ã€æŠ¼é‡‘è¦å‰‡ï¼Œä»¥åŠç’°å¢ƒå®‰å…¨
ğŸ” ä¸€ã€æˆ¿æ±èˆ‡æˆ¿å±‹çš„åˆæ³•æ€§
ç¢ºèªæˆ¿æ±èº«åˆ†æ˜¯å¦ç‚ºæˆ¿å±‹æ‰€æœ‰äºº
å¯è¦æ±‚æˆ¿æ±å‡ºç¤ºã€Œæˆ¿å±‹æ¬Šç‹€ã€æˆ–ã€Œæœ€è¿‘ä¸€æœŸçš„æˆ¿å±‹ç¨…å–®ã€ï¼Œç¢ºèªä»–æ˜¯å¦ç‚ºç™»è¨˜æ‰€æœ‰äººã€‚

æ˜¯å¦ç‚ºåˆæ³•ç”¨é€”çš„ä½å®…
æŸ¥è©¢ã€Œä½¿ç”¨åˆ†å€ã€æ˜¯å¦å…è¨±ç•¶ä½å®…ä½¿ç”¨ã€‚æœ‰äº›è¾¦å…¬å¤§æ¨“ã€å·¥æ¥­ç”¨åœ°ä¸èƒ½ä½œç‚ºä½å®…å‡ºç§Ÿã€‚

é•å»ºæˆ–åˆ†ç§Ÿå¥—æˆ¿è¦ç‰¹åˆ¥å°å¿ƒ
é•å»ºå¯èƒ½éš¨æ™‚è¢«æ‹†é™¤ï¼Œå±…ä½å®‰å…¨å ªæ…®ï¼›åˆ†ç§Ÿå¥—æˆ¿è‹¥ç„¡æ¶ˆé˜²è¨­æ–½ï¼Œä¹Ÿæœ‰é‡å¤§å®‰å…¨ç–‘æ…®ã€‚

ğŸ“ äºŒã€ç§Ÿç´„å…§å®¹è¦æ¸…æ¥š
ä¸€å®šè¦ç°½è¨‚æ›¸é¢å¥‘ç´„
æ›¸é¢å¥‘ç´„æ˜¯ä¿éšœé›™æ–¹æ¬Šç›Šçš„åŸºç¤ï¼Œå»ºè­°ä½¿ç”¨å…§æ”¿éƒ¨æä¾›çš„ã€å®šå‹åŒ–å¥‘ç´„ç¯„æœ¬ã€‘ã€‚

æ˜ç¢ºåˆ—å‡ºç§Ÿé‡‘ã€æŠ¼é‡‘ã€ç§ŸæœŸã€æ°´é›»è²»ã€ç®¡ç†è²»ç­‰è²»ç”¨è¨ˆç®—æ–¹å¼

æ˜¯å¦å¯ä»¥æå‰è§£ç´„ï¼Ÿé•ç´„é‡‘æ€éº¼è¨ˆç®—ï¼Ÿ
æœ‰äº›æˆ¿æ±æœƒè¦æ±‚æå‰è§£ç´„éœ€ä»˜é•ç´„é‡‘ï¼Œä¸€å®šè¦åœ¨å¥‘ç´„å…§å¯«æ¸…æ¥šæ¢ä»¶èˆ‡é‡‘é¡ã€‚

æŠ¼é‡‘æœ€å¤šä¸å¾—è¶…éå…©å€‹æœˆç§Ÿé‡‘ï¼ˆä¾ã€Šæ°‘æ³•ã€‹ç¬¬450æ¢ï¼‰

ğŸ  ä¸‰ã€å…¥ä½å‰å¯¦åœ°æª¢æŸ¥
æª¢æŸ¥æ°´é›»ç®¡ç·šã€å†·æ°£ç†±æ°´å™¨æ˜¯å¦æ­£å¸¸
ç™¼ç¾å•é¡Œè¦æ‹ç…§æˆ–éŒ„å½±å­˜è­‰ï¼Œä¸¦åœ¨å¥‘ç´„ä¸­è¨»æ˜ç”±èª°è² è²¬ä¿®ç¹•ã€‚

æ¸…é»èˆ‡ç´€éŒ„å®¶å…·å®¶é›»çš„ç¾æ³
å¯åˆ—å‡ºæ¸…å–®ä¸¦é™„åœ¨ç§Ÿç´„å¾Œæ–¹ï¼ˆä½œç‚ºé™„ä»¶ï¼‰ã€‚

âš ï¸ å››ã€æ³¨æ„æˆ¿æ±é•æ³•è¡Œç‚º
å¼·åˆ¶æ”¶çœ‹é›»è¦–ã€é™åˆ¶ç”¨æ°´ç”¨é›»ã€é™åˆ¶è¨ªå®¢é€²å‡ºç­‰è¡Œç‚ºï¼Œå¯èƒ½é•åã€Šä½å®…æ³•ã€‹æˆ–ã€Šæ°‘æ³•ã€‹ã€‚

æˆ¿æ±è‹¥ç„¡ä½ åŒæ„å°±é€²å±‹ï¼Œæ¶‰å«Œä¾µçŠ¯éš±ç§æˆ–é•æ³•ä¾µå…¥ä½å±…ã€‚

ğŸ“Œ å°æŠ€å·§èˆ‡å»ºè­°
å¤šçœ‹å¹¾é–“æˆ¿å­å†æ±ºå®šï¼Œé¿å…è¡å‹•ç§Ÿæˆ¿ã€‚

ä¿ç•™ç§Ÿå±‹å°è©±ç´€éŒ„ï¼ˆLINEã€emailã€ç°¡è¨Šï¼‰ï¼Œæ—¥å¾Œå¦‚ç™¼ç”Ÿçˆ­è­°æœ‰æ†‘æœ‰æ“šã€‚

è‹¥å°ç§Ÿç´„æ¢æ¬¾ä¸ç¢ºå®šï¼Œå¯å§”è¨—å¾‹å¸«æˆ–å‘ç•¶åœ°æ³•å¾‹æ‰¶åŠ©åŸºé‡‘æœƒè«®è©¢ã€‚'''
tax_intro_msg = '''
ä¸€ã€å¸¸è¦‹çš„ç§Ÿå±‹è£œåŠ©æ–¹æ¡ˆ
| è£œåŠ©åç¨±                | é©ç”¨å°è±¡         | é‡‘é¡                       | ç”³è«‹æ¢ä»¶                       |
| ------------------- | ------------ | ------------------------ | -------------------------- |
| **ç§Ÿé‡‘è£œè²¼**            | å¼±å‹¢æ—ç¾¤ã€é’å¹´ã€å®¶åº­   | æ¯æœˆæœ€é«˜ 8,000 å…ƒï¼ˆä¾ç¸£å¸‚èˆ‡å®¶æˆ¶äººæ•¸åˆ†ç´šï¼‰ | æœ‰ç§Ÿè³ƒå¥‘ç´„ã€æœ‰å ±ç¨…ã€æœ‰è¨­ç±ï¼Œä¸”å®¶åº­æ”¶å…¥åœ¨ä¸€å®šæ¨™æº–ä»¥ä¸‹ |
| **åŒ…ç§Ÿä»£ç®¡è£œåŠ©**          | æˆ¿æ±ã€æˆ¿å®¢å‡å¯ç”³è«‹    | æˆ¿å®¢æ¯æœˆè£œåŠ©ç§Ÿé‡‘ã€æˆ¿æ±äº«ç¨…è³¦å„ªæƒ          | é ˆé€éæ”¿åºœèªå¯ä¹‹ä»£ç®¡æ¥­è€…ç°½è¨‚å¥‘ç´„           |
| **é’å¹´ç§Ÿå±‹è£œåŠ©**          | å¹´è¼•æ—ç¾¤ï¼ˆ20ï½40æ­²ï¼‰ | åŒ—åŒ—åŸºæœ€å¤šæ¯æœˆ 5,000 å…ƒ          | é ˆæœ‰æ­£å¼ç§Ÿç´„ã€å®¶åº­æ‰€å¾—é™åˆ¶              |
| **ä¸­ä½æ”¶å…¥æˆ¶ã€èº«å¿ƒéšœç¤™è€…ç§Ÿå±‹è£œåŠ©** | ç‰¹æ®Šèº«ä»½         | è£œåŠ©é¡åº¦è¼ƒé«˜                   | é ˆæœ‰è¨­ç±èˆ‡èº«ä»½è­‰æ˜                  |


äºŒã€ç§Ÿé‡‘å ±ç¨…èˆ‡ç›¸é—œç¨…å‹™è¦ç¯„
å°æˆ¿å®¢ï¼ˆä½ ï¼‰ä¾†èªªï¼š
âœ… ä½ å¯ä»¥å ±ç¨…ç¯€ç¨…ï¼ˆåˆ—èˆ‰æ‰£é™¤é¡ï¼‰

æ¢ä»¶ï¼šæœ‰ã€Œæ­£å¼ç§Ÿè³ƒå¥‘ç´„ã€èˆ‡ã€Œæˆ¿æ±å ±ç¨…æˆ–é–‹ç«‹æ”¶æ“šã€ã€‚

å¯åœ¨ç¶œåˆæ‰€å¾—ç¨…å ±ç¨…æ™‚ç”³å ± ç§Ÿé‡‘æ”¯å‡ºï¼Œæ¯å¹´æœ€å¤šå¯æŠµç¨… 12 è¬å…ƒï¼ˆå³æ¯æœˆ 10,000 å…ƒå…§ï¼‰ã€‚

âš ï¸ è‹¥æˆ¿æ±æœªå ±ç¨…ï¼Œä½ å ±ç¨…å°‡å¯èƒ½å°è‡´æˆ¿æ±è¢«æŸ¥ç¨…

å»ºè­°èˆ‡æˆ¿æ±æºé€šæ˜¯å¦é¡˜æ„é–‹ç«‹ã€Œç§Ÿé‡‘æ”¶æ“šã€ä¸¦å ±ç¨…ã€‚

äºŒã€ç§Ÿé‡‘å ±ç¨…èˆ‡ç›¸é—œç¨…å‹™è¦ç¯„
å°æˆ¿å®¢ï¼ˆä½ ï¼‰ä¾†èªªï¼š
âœ… ä½ å¯ä»¥å ±ç¨…ç¯€ç¨…ï¼ˆåˆ—èˆ‰æ‰£é™¤é¡ï¼‰

æ¢ä»¶ï¼šæœ‰ã€Œæ­£å¼ç§Ÿè³ƒå¥‘ç´„ã€èˆ‡ã€Œæˆ¿æ±å ±ç¨…æˆ–é–‹ç«‹æ”¶æ“šã€ã€‚

å¯åœ¨ç¶œåˆæ‰€å¾—ç¨…å ±ç¨…æ™‚ç”³å ± ç§Ÿé‡‘æ”¯å‡ºï¼Œæ¯å¹´æœ€å¤šå¯æŠµç¨… 12 è¬å…ƒï¼ˆå³æ¯æœˆ 10,000 å…ƒå…§ï¼‰ã€‚

âš ï¸ è‹¥æˆ¿æ±æœªå ±ç¨…ï¼Œä½ å ±ç¨…å°‡å¯èƒ½å°è‡´æˆ¿æ±è¢«æŸ¥ç¨…

å»ºè­°èˆ‡æˆ¿æ±æºé€šæ˜¯å¦é¡˜æ„é–‹ç«‹ã€Œç§Ÿé‡‘æ”¶æ“šã€ä¸¦å ±ç¨…ã€‚

ä¸‰ã€å…è²»æ³•å¾‹è³‡æºï¼ˆå”åŠ©ç§Ÿå±‹ç³¾ç´›ï¼‰
ğŸ§‘â€âš–ï¸ æ³•å¾‹è«®è©¢èˆ‡å”åŠ©ç®¡é“ï¼š
| è³‡æºå–®ä½                  | æä¾›å…§å®¹             | è¯çµ¡æ–¹å¼                                     |
| --------------------- | ---------------- | ---------------------------------------- |
| **æ³•å¾‹æ‰¶åŠ©åŸºé‡‘æœƒ**           | å…è²»æ³•å¾‹è«®è©¢ã€å¿…è¦æ™‚æä¾›å¾‹å¸«å”åŠ© | [www.laf.org.tw](https://www.laf.org.tw) |
| **å„ç¸£å¸‚æ”¿åºœæ³•æ‰¶çª—å£**         | å®šæœŸé–‹æ”¾æ³•å¾‹è«®è©¢æ™‚æ®µ       | å¯é›»è©±æˆ–ç¶²è·¯é ç´„                                 |
| **å¸æ³•é™¢æ³•å¾‹è«®è©¢ç¶²ç«™**         | åŸºæœ¬æ³•å¾‹å•é¡Œç·šä¸Šè«®è©¢       | [law.moj.gov.tw](https://law.moj.gov.tw) |
| **ç¤¾å€æ³•å¾‹è«®è©¢ï¼ˆæ°‘æ„ä»£è¡¨ã€ç¤¾å€ä¸­å¿ƒï¼‰** | é€šå¸¸ä¸å®šæœŸè¾¦ç†ï¼Œå…è²»       | å¯ç•™æ„ç•¶åœ°å…¬å‘Š                                  |


'''



def handle_first_rent():
    handle_common_problem(intro_msg= first_rent_intro_message,history=first_rent_intro_message)

def handle_tax():
    handle_common_problem(intro_msg=tax_intro_msg,history=tax_intro_msg)